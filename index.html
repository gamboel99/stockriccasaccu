<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RICCAS ACCU - Aplikasi Stok (Terang)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="codes.js"></script>
<style>
  :root{
    --bg: #f4f6f8;
    --card: #ffffff;
    --muted: #333333;
    --accent: #ff7a00;
    --border: #e2e8f0;
  }
  body{background:var(--bg);color:var(--muted);font-family:Inter,Arial,sans-serif;margin:0;padding:20px}
  .container{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;gap:16px;padding:12px 16px;background:var(--card);border-radius:10px;box-shadow:0 2px 8px rgba(16,24,40,0.06)}
  header img{height:72px;width:72px;border-radius:8px;object-fit:cover;border:2px solid #fff}
  header h1{margin:0;font-size:20px;color:var(--muted)}
  .top-row{display:flex;gap:12px;margin-top:16px;align-items:flex-start}
  .card{background:var(--card);padding:14px;border-radius:10px;flex:1;box-shadow:0 6px 18px rgba(16,24,40,0.06);border:1px solid var(--border)}
  form label{display:block;color:var(--muted);font-size:13px;margin-top:8px}
  input[type=text],input[list],input[type=number],select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted)}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:#666}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:transparent}
  th,td{padding:8px;border:1px solid var(--border);text-align:center;color:var(--muted);background:transparent}
  th{background:#fff;color:var(--accent);font-weight:600}
  .category-title{display:flex;align-items:center;justify-content:space-between}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .export-btn{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:6px 10px;border-radius:8px}
  footer{text-align:center;color:#777;margin-top:16px;font-size:12px}
  @media (max-width:900px){ .top-row{flex-direction:column} }
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="Desain tanpa judul (7).png" alt="Logo RICCAS ACCU"/>
    <div>
      <h1>RICCAS ACCU</h1>
      <div class="small">Aplikasi Stok Barang — Dipisah per Kategori</div>
    </div>
  </header>

  <div class="top-row">
    <div class="card" style="flex:0.6;">
      <h3>Input Transaksi</h3>
      <form id="formInput">
        <label>Kode Barang</label>
        <input list="codeList" id="kode" placeholder="Pilih / ketik kode..." autocomplete="off" required />
        <datalist id="codeList"></datalist>

        <label>Kategori (otomatis bila memilih dari daftar)</label>
        <select id="categorySelect">
          <option value="">-- pilih kategori (opsional) --</option>
        </select>

        <label>Tipe</label>
        <select id="tipe">
          <option value="masuk">Masuk</option>
          <option value="keluar">Keluar</option>
        </select>

        <label>Qty</label>
        <input type="number" id="qty" value="1" min="1" />

        <label>Harga Satuan (opsional)</label>
        <input type="number" id="price" placeholder="Rp" />

        <div style="margin-top:10px;display:flex;gap:8px;">
          <button type="submit">Simpan</button>
          <button type="button" onclick="resetData()" style="background:#ef4444">Reset Semua</button>
        </div>
      </form>

      <hr style="border-color:var(--border);margin:10px 0">

      <h4>Tambah Item Baru (masuk kategori: LAIN_LAIN)</h4>
      <form id="formAdd">
        <label>Nama / Kode Item</label>
        <input type="text" id="newItem" placeholder="contoh: AIR ACCU"/>
        <label>Masukkan kategori (opsional)</label>
        <input type="text" id="newCat" placeholder="contoh: Consumable"/>
        <div style="margin-top:8px"><button type="submit">Tambah Item</button></div>
      </form>
    </div>

    <div class="card" style="flex:0.4;">
      <h3>Kontrol & Ekspor</h3>
      <div class="actions">
        <button class="export-btn" onclick="exportExcel()">Export Excel Semua</button>
        <button onclick="exportCategory()">Export Per Kategori</button>
      </div>
      <div style="margin-top:12px">
        <label class="small">Cari (kode atau nama)</label>
        <input type="text" id="search" placeholder="ketik untuk cari..." oninput="renderAll()" />
      </div>
      <div style="margin-top:12px">
        <label class="small">Filter kategori</label>
        <select id="filterCat" onchange="renderAll()">
          <option value="">Semua Kategori</option>
        </select>
      </div>
    </div>
  </div>

  <div id="categoriesArea" style="margin-top:18px;"></div>

  <footer>RICCAS ACCU • Aplikasi Stok • Data disimpan di browser (localStorage)</footer>
</div>

<script>
const STORAGE_KEY = "riccas_accu_app_final_v1";
let state = { items: {}, history: [] };

function initState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) state = JSON.parse(raw);
  for (const [cat, arr] of Object.entries(CATEGORIES)) {
    for (const code of arr) {
      if (!state.items[code]) {
        state.items[code] = { kode: code, kategori: cat, stok_awal: 0, stock: 0, last_price: null };
      } else {
        if (!state.items[code].kategori) state.items[code].kategori = cat;
      }
    }
  }
  saveState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function resetData() {
  if (!confirm('Hapus semua data (history & stocks)?')) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { items: {}, history: [] };
  initState();
  renderAll();
}

function buildLists() {
  const codeList = document.getElementById('codeList');
  codeList.innerHTML = '';
  ALL_CODES.forEach(c => {
    const o = document.createElement('option'); o.value = c; codeList.appendChild(o);
  });
  const categorySelect = document.getElementById('categorySelect');
  categorySelect.innerHTML = '<option value="">-- pilih kategori (opsional) --</option>';
  const filterCat = document.getElementById('filterCat');
  filterCat.innerHTML = '<option value="">Semua Kategori</option>';
  for (const cat of Object.keys(CATEGORIES)) {
    const opt = document.createElement('option'); opt.value = cat; opt.text = cat.replace(/_/g,' '); categorySelect.appendChild(opt);
    const opt2 = opt.cloneNode(true); filterCat.appendChild(opt2);
  }
}

function renderAll() {
  const area = document.getElementById('categoriesArea'); area.innerHTML = '';
  const search = document.getElementById('search').value.toLowerCase();
  const filterCat = document.getElementById('filterCat').value;
  for (const [cat, arr] of Object.entries(CATEGORIES)) {
    if (filterCat && filterCat !== cat) continue;
    const panel = document.createElement('div'); panel.className='card'; panel.style.marginBottom='12px';
    const title = document.createElement('div'); title.className='category-title';
    title.innerHTML = `<strong style="color:var(--accent)">${cat.replace(/_/g,' ')}</strong><span class="small">Jumlah item: ${arr.length}</span>`;
    panel.appendChild(title);
    const table = document.createElement('table');
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Kode Barang</th><th>Stok Awal</th><th>Stok Sekarang</th><th>Harga Terakhir</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for (const code of arr) {
      const it = state.items[code] || { kode: code, kategori: cat, stok_awal:0, stock:0, last_price:null };
      if (search && !(code.toLowerCase().includes(search))) continue;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left;padding-left:10px">${it.kode}</td>
                      <td>${it.stok_awal ?? 0}</td>
                      <td>${it.stock ?? 0}</td>
                      <td>${it.last_price!=null?('Rp '+Number(it.last_price).toLocaleString()):'-'}</td>`;
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    panel.appendChild(table);
    area.appendChild(panel);
  }
}

document.getElementById('formInput').addEventListener('submit', function(e){
  e.preventDefault();
  const kode = document.getElementById('kode').value.trim();
  const tipe = document.getElementById('tipe').value;
  const qty = Number(document.getElementById('qty').value) || 0;
  const price = document.getElementById('price').value ? Number(document.getElementById('price').value) : null;
  const specifiedCat = document.getElementById('categorySelect').value;

  if (!kode){ alert('Masukkan kode barang!'); return; }

  let catFound = null;
  for (const [cat, arr] of Object.entries(CATEGORIES)) {
    if (arr.includes(kode)) { catFound = cat; break; }
  }
  if (!catFound) catFound = specifiedCat || 'LAIN_LAIN';

  if (!state.items[kode]) {
    state.items[kode] = { kode: kode, kategori: catFound, stok_awal:0, stock:0, last_price: price };
    if (!CATEGORIES[catFound]) CATEGORIES[catFound] = [];
    if (!CATEGORIES[catFound].includes(kode)) CATEGORIES[catFound].push(kode);
    buildLists();
  }

  if (tipe === 'masuk') state.items[kode].stock = (Number(state.items[kode].stock)||0) + qty;
  else state.items[kode].stock = (Number(state.items[kode].stock)||0) - qty;

  if (price !== null) state.items[kode].last_price = price;

  state.history.unshift({ time: Date.now(), kode, tipe, qty, price, kategori: state.items[kode].kategori });
  saveState();
  renderAll();
  this.reset();
});

document.getElementById('formAdd').addEventListener('submit', function(e){
  e.preventDefault();
  const newItem = document.getElementById('newItem').value.trim();
  const newCat = document.getElementById('newCat').value.trim() || 'LAIN_LAIN';
  if (!newItem) return alert('Masukkan nama / kode item baru.');
  if (!CATEGORIES[newCat]) CATEGORIES[newCat] = [];
  if (!CATEGORIES[newCat].includes(newItem)) {
    CATEGORIES[newCat].push(newItem);
  }
  if (!state.items[newItem]) state.items[newItem] = { kode:newItem, kategori:newCat, stok_awal:0, stock:0, last_price:null };
  saveState(); buildLists(); renderAll();
  this.reset();
  alert('Item baru ditambahkan ke kategori: ' + newCat);
});

function exportExcel() {
  const summary = [];
  for (const [kode, it] of Object.entries(state.items)) {
    summary.push({ Kategori: it.kategori, Kode: it.kode, "Stok Awal": it.stok_awal, "Stok Sekarang": it.stock, "Harga Terakhir": it.last_price });
  }
  const history = state.history.map(h => ({ Waktu: new Date(h.time).toLocaleString(), Kode: h.kode, Kategori: h.kategori, Tipe: h.tipe, Qty: h.qty, Harga: h.price }));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), 'Summary');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(history), 'History');
  XLSX.writeFile(wb, 'RICCAS_ACCU_Stock_All.xlsx');
}

function exportCategory() {
  const cat = prompt('Masukkan nama kategori persis seperti pada daftar (contoh: GS_ASTRA) atau kosong untuk semua:');
  if (!cat) { exportExcel(); return; }
  const arr = CATEGORIES[cat];
  if (!arr) return alert('Kategori tidak ditemukan.');
  const summary = arr.map(k => {
    const it = state.items[k] || { kode:k, stok_awal:0, stock:0, last_price:null };
    return { Kode: it.kode, "Stok Awal": it.stok_awal, "Stok Sekarang": it.stock, "Harga Terakhir": it.last_price };
  });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), cat);
  XLSX.writeFile(wb, 'RICCAS_ACCU_' + cat + '.xlsx');
}

initState();
buildLists();
renderAll();
</script>
</body>
</html>
